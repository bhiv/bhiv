#!/bin/sh

yolo_cli () {
    action="$1";
    if [ -n "$1" ]; then shift; fi
    case "$action" in
        install) yolo_install $@;;
        update)  yolo_update $@;;

        create)      yolo_create $@;;
        init)        yolo_init_project $@;;
        init-module) yolo_init_module $@;;
        link)        yolo_link $@;;

        set-magic)   yolo_set_magic $@;;

        run)     yolo_run $@;;
        test)    yolo_test $@;;

        start)   yolo_start $@;;
        stop)    yolo_stop $@;;
        restart) yolo_restart $@;;

        bind-module)   yolo_bind_module $@;;
        unbind-module) yolo_unbind_module $@;;

        help)    yolo_synopsis $@;;
        *)       yolo_synopsis $@;;
    esac
    exit ;
}

################################################################
THIS=$(dirname "$(readlink "$0" || echo "$0")")
errcho () { echo $@ 1>&2; }
capitalize () { echo "$(echo -n "$1" | cut -c1 | tr '[a-z]' '[A-Z]')$(echo -n "$1" | cut -c2-)"; }
json () { "$THIS/json" "$1" "$2" "$3" "$4" "$5"; }

VERSION=$(json "$THIS/../package.json" "get-string" "version")

################################################################

yolo_install () {
    sudo npm install -g 'https://github.com/np42/yolojs#master'
}

yolo_init () {
    if [ ! -d package.json ]
    then
        npm init -y
        json package.json set-string 'main' "$1"
        json package.json set-string 'scripts.test' 'mocha'
        npm install --save-dev mocha
    fi

    ignore=".gitignore"

    yolo_link

    if [ ! -e "$ignore" ]
    then
        echo -n > "$ignore"
        echo '*~' >> "$ignore"
        echo '.#*#' >> "$ignore"
        echo '#*#' >> "$ignore"
        echo 'node_modules' >> "$ignore"
        echo 'npm-debug.log' >> "$ignore"
    fi

    mkdir -p app config test docs resources
}

yolo_init_module () {
    index="index.js"

    yolo_init "$index"

    post='(MODULE=$(basename $(pwd)); cd ../..; node_modules/yolojs/bin/yolo-cli bind-module $MODULE)'
    json package.json set-string 'scripts.postinstall' "$post"
    json package.json set-string 'peerDependencies.yolojs' "^$yolojs_version"

    if [ ! -e "$index" ]
    then
        echo "console.log('Module can\\'t be executed, run npm test');" > "$index"
    fi
}

yolo_init_project () {
    index="index.js"

    yolo_init "$index"

    if [ ! -e "$index" ]
    then
        echo "require('yolojs');" > "$index"
    fi
}

yolo_create () {
    name="$1"
    port="$2"
    Name=$(capitalize "$name")

    if [ -d app -o -d config ]; then errcho "Not empty project"; exit 1; fi
    if [ -z "$port" ]; then port=7000; fi
    if [ -z "$name" ]; then yolo_synopsis $@; fi

    route="config/route-$name.$port.map"
    config="config/config-custom.json"
    controller="app/$Name/Controller/Controller.js"
    home="app/$Name/View/Home.nsb"

    mkdir -p node_modules
    mkdir -p "app/$Name/View"
    mkdir -p "app/$Name/Controller"
    mkdir -p "static/$name"

    yolo_init

    cat << EOF > "$route"
Http GET / $Name.Controller:page-home
EOF

    cat << EOF > "$controller"
module.exports = function (node) {

  node.on('page-home', function (payload, event) {
    var webpage = { type: 'webpage' };
    webpage.title = 'Home Page';
    webpage.body = { fqn: '$Name.View.Home', params: { "text": "Hello world" } };
    return event.reply(null, webpage);
  });

};
EOF

    cat << EOF > "$config"
{ "Services":
  { "App.Routing": { "events": [ [ ":set", "$route" ] ] }
  }
, "Config":
  {
  }
}
EOF

    cat << EOF > "$home"
Yolo.Ui.Dom {
  + Less style:
    .this { text-align: center; color: #333; }

  > Jade html:
    h1(id=id, class=tags.concat(' '))= params.text

}
EOF
}

yolo_link () {
    npm link -no-bin-links yolojs
}

################################################################

yolo_set_magic () {

    while [ -n "$1" ]
    do
        ex "$1" +1 -c 'i|/*!UroxGvT3uDMQCT1va20i43ZZSxo*/' -c x
        shift
    done

}

################################################################

yolo_run () {
    node index.js
}

yolo_test () {
    node index.js --test $@
}

################################################################

yolo_start () {
    echo
}

yolo_stop () {
    echo
}

yolo_restart () {
    echo
}

################################################################

yolo_bind_module () {
    NAME="$(basename $(pwd))"
    DEPENDENCIES="config/elders.txt"
    MODULE='node_modules/'"$NAME"
    if grep "$MODULE" "$DEPENDENCIES" 2> /dev/null > /dev/null
    then
        echo "($NAME) Already bound"
    else
        echo "$MODULE" >> "$DEPENDENCIES"
    fi
}

yolo_unbind_module () {
    echo $@
}

################################################################

yolo_synopsis () {
    echo "SYNOPSIS: yolo-cli <action> [<args>]"
    if [ "$0" = "help" ]; then exit 0;
    else exit 1; fi
}

################################################################

yolo_cli $@
